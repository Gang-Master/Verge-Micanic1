<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام البحث المتقدم للمركبات الشرطية</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --admin-color: #e74c3c;
            --editor-color: #f39c12;
            --viewer-color: #27ae60;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        .sidebar {
            height: 100vh;
            position: fixed;
            right: 0;
            top: 0;
            background-color: var(--primary-color);
            color: white;
            padding-top: 20px;
            width: 250px;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .main-content {
            margin-right: 250px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                margin-right: -250px;
            }
            
            .sidebar.active {
                margin-right: 0;
            }
            
            .main-content {
                margin-right: 0;
            }
        }
        
        .sidebar a {
            color: white;
            text-decoration: none;
            display: block;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        
        .sidebar a:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .sidebar a.active {
            background-color: var(--secondary-color);
        }
        
        .user-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-admin {
            background-color: var(--admin-color);
        }
        
        .badge-editor {
            background-color: var(--editor-color);
        }
        
        .badge-viewer {
            background-color: var(--viewer-color);
        }
        
        .vehicle-card {
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s;
            height: 100%;
        }
        
        .vehicle-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .vehicle-img-container {
            height: 200px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f5f5f5;
        }
        
        .vehicle-img {
            max-height: 100%;
            max-width: 100%;
            object-fit: cover;
        }
        
        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-block;
            margin: 0 5px;
            border: 1px solid #ddd;
        }
        
        .login-container {
            max-width: 500px;
            margin: 100px auto;
            padding: 30px;
            border-radius: 10px;
            background-color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .logo {
            font-weight: bold;
            font-size: 24px;
            color: var(--primary-color);
        }
        
        .logo span {
            color: var(--secondary-color);
        }
        
        .section-title {
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
            margin-bottom: 30px;
            color: var(--primary-color);
        }
        
        .toggle-sidebar {
            display: none;
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1001;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
        }
        
        @media (max-width: 768px) {
            .toggle-sidebar {
                display: block;
            }
        }
        
        .dashboard-card {
            border-radius: 10px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .dashboard-card i {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .card-admin {
            background-color: var(--admin-color);
        }
        
        .card-editor {
            background-color: var(--editor-color);
        }
        
        .card-viewer {
            background-color: var(--viewer-color);
        }
        
        .card-vehicles {
            background-color: #9b59b6;
        }
        
        .card-sectors {
            background-color: #1abc9c;
        }
    </style>
</head>
<body>
    <!-- تسجيل الدخول -->
    <div id="login-page" class="login-container">
        <div class="text-center mb-4">
            <h1 class="logo">نظام <span>البحث</span> المتقدم</h1>
            <p class="text-muted">إدارة وتصفح المركبات الشرطية</p>
        </div>
        
        <div class="mb-3">
            <label for="login-email" class="form-label">البريد الإلكتروني</label>
            <input type="email" class="form-control" id="login-email" placeholder="أدخل بريدك الإلكتروني">
        </div>
        
        <div class="mb-3">
            <label for="login-password" class="form-label">كلمة المرور</label>
            <input type="password" class="form-control" id="login-password" placeholder="أدخل كلمة المرور">
        </div>
        
        <div class="d-grid gap-2">
            <button class="btn btn-primary" onclick="login()">تسجيل الدخول</button>
            <button class="btn btn-outline-secondary" onclick="showRegister()">إنشاء حساب جديد</button>
        </div>
        
        <div id="login-error" class="alert alert-danger mt-3 d-none"></div>
    </div>

    <!-- تسجيل مستخدم جديد -->
    <div id="register-page" class="login-container d-none">
        <div class="text-center mb-4">
            <h1 class="logo">إنشاء <span>حساب</span> جديد</h1>
            <p class="text-muted">يرجى تعبئة البيانات التالية</p>
        </div>
        
        <div class="mb-3">
            <label for="register-name" class="form-label">الاسم الكامل</label>
            <input type="text" class="form-control" id="register-name" placeholder="أدخل اسمك الكامل">
        </div>
        
        <div class="mb-3">
            <label for="register-email" class="form-label">البريد الإلكتروني</label>
            <input type="email" class="form-control" id="register-email" placeholder="أدخل بريدك الإلكتروني">
        </div>
        
        <div class="mb-3">
            <label for="register-password" class="form-label">كلمة المرور</label>
            <input type="password" class="form-control" id="register-password" placeholder="أدخل كلمة المرور (6 أحرف على الأقل)">
        </div>
        
        <div class="mb-3">
            <label for="register-role" class="form-label">دور المستخدم</label>
            <select class="form-control" id="register-role">
                <option value="viewer">مشاهد (يمكنه البحث والمشاهدة فقط)</option>
                <option value="editor">محرر (يمكنه إضافة وتعديل البيانات)</option>
                <option value="admin">مدير (صلاحيات كاملة)</option>
            </select>
        </div>
        
        <div class="d-grid gap-2">
            <button class="btn btn-primary" onclick="register()">إنشاء الحساب</button>
            <button class="btn btn-outline-secondary" onclick="showLogin()">العودة لتسجيل الدخول</button>
        </div>
        
        <div id="register-error" class="alert alert-danger mt-3 d-none"></div>
    </div>

    <!-- لوحة التحكم الرئيسية -->
    <div id="dashboard" class="d-none">
        <!-- شريط التنقل الجانبي -->
        <button class="toggle-sidebar" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="sidebar" id="sidebar">
            <div class="text-center mb-4">
                <h2 class="logo">نظام <span>البحث</span></h2>
                <p class="text-muted small" id="user-info">مرحباً، محمد</p>
                <span class="user-badge" id="user-role-badge">مدير</span>
            </div>
            
            <a href="#" class="active" onclick="showSection('dashboard-home')">
                <i class="fas fa-home me-2"></i> لوحة التحكم
            </a>
            
            <a href="#" onclick="showSection('search-vehicles')">
                <i class="fas fa-search me-2"></i> بحث المركبات
            </a>
            
            <a href="#" onclick="showSection('add-vehicle')" id="add-vehicle-link">
                <i class="fas fa-car me-2"></i> إضافة مركبة
            </a>
            
            <a href="#" onclick="showSection('manage-sectors')" id="manage-sectors-link">
                <i class="fas fa-list me-2"></i> إدارة القطاعات
            </a>
            
            <a href="#" onclick="showSection('manage-colors')" id="manage-colors-link">
                <i class="fas fa-palette me-2"></i> إدارة الألوان
            </a>
            
            <a href="#" onclick="showSection('manage-users')" id="manage-users-link">
                <i class="fas fa-users me-2"></i> إدارة المستخدمين
            </a>
            
            <a href="#" onclick="logout()" class="mt-5">
                <i class="fas fa-sign-out-alt me-2"></i> تسجيل الخروج
            </a>
        </div>
        
        <!-- المحتوى الرئيسي -->
        <div class="main-content" id="main-content">
            <!-- لوحة التحكم الرئيسية -->
            <div id="dashboard-home" class="dashboard-section">
                <h2 class="section-title">لوحة التحكم</h2>
                
                <div class="row">
                    <div class="col-md-3 col-sm-6">
                        <div class="dashboard-card card-admin">
                            <i class="fas fa-user-shield"></i>
                            <h4>المديرون</h4>
                            <h2 id="admin-count">0</h2>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6">
                        <div class="dashboard-card card-editor">
                            <i class="fas fa-edit"></i>
                            <h4>المحررون</h4>
                            <h2 id="editor-count">0</h2>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6">
                        <div class="dashboard-card card-viewer">
                            <i class="fas fa-eye"></i>
                            <h4>المشاهدون</h4>
                            <h2 id="viewer-count">0</h2>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-sm-6">
                        <div class="dashboard-card card-vehicles">
                            <i class="fas fa-car"></i>
                            <h4>المركبات</h4>
                            <h2 id="vehicle-count">0</h2>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">آخر المركبات المضافة</h5>
                                <div id="recent-vehicles" class="mt-3">
                                    <!-- سيتم ملؤها بالبيانات -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">إحصائيات النظام</h5>
                                <canvas id="stats-chart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- قسم البحث -->
            <div id="search-vehicles" class="dashboard-section d-none">
                <h2 class="section-title">بحث المركبات</h2>
                
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">نوع المركبة</label>
                                <select class="form-control" id="search-type">
                                    <option value="">جميع الأنواع</option>
                                    <option value="الفورد فكتوريا">الفورد فكتوريا</option>
                                    <option value="الدودج تشارجر">الدودج تشارجر</option>
                                    <option value="فورد اكسبلور">فورد اكسبلور</option>
                                    <option value="تاهو">تاهو</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">القطاع</label>
                                <select class="form-control" id="search-sector">
                                    <option value="">جميع القطاعات</option>
                                    <!-- سيتم ملؤها بالبيانات -->
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">اللون</label>
                                <div id="color-filter">
                                    <!-- سيتم ملؤها بالبيانات -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button class="btn btn-primary" onclick="searchVehicles()">
                                <i class="fas fa-search me-2"></i>بحث
                            </button>
                            <button class="btn btn-outline-secondary" onclick="resetSearch()">
                                <i class="fas fa-redo me-2"></i>إعادة تعيين
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="row" id="search-results">
                    <!-- سيتم ملؤها بالبيانات -->
                </div>
            </div>
            
            <!-- إضافة مركبة جديدة -->
            <div id="add-vehicle" class="dashboard-section d-none">
                <h2 class="section-title">إضافة مركبة جديدة</h2>
                
                <div class="card">
                    <div class="card-body">
                        <form id="add-vehicle-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">نوع المركبة *</label>
                                    <select class="form-control" id="vehicle-type" required>
                                        <option value="">اختر نوع المركبة</option>
                                        <option value="الفورد فكتوريا">الفورد فكتوريا</option>
                                        <option value="الدودج تشارجر">الدودج تشارجر</option>
                                        <option value="فورد اكسبلور">فورد اكسبلور</option>
                                        <option value="تاهو">تاهو</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">الكود الفني *</label>
                                    <input type="text" class="form-control" id="vehicle-code" required>
                                    <small class="text-muted">مثال: cvpi_sign_1 أو alphatexture</small>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">القطاع *</label>
                                    <select class="form-control" id="vehicle-sector" required>
                                        <option value="">اختر القطاع</option>
                                        <!-- سيتم ملؤها بالبيانات -->
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">الرابط المرجعي *</label>
                                    <input type="url" class="form-control" id="vehicle-image" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">اللون الأول *</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="primary-color" placeholder="مثال: 4c4c4c" required>
                                        <span class="input-group-text color-preview" id="primary-color-preview"></span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">اللون الثانوي *</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="secondary-color" placeholder="مثال: FFFFFF" required>
                                        <span class="input-group-text color-preview" id="secondary-color-preview"></span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">ملاحظات إضافية</label>
                                <textarea class="form-control" id="vehicle-notes" rows="3"></textarea>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>حفظ المركبة
                                </button>
                                <button type="reset" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-2"></i>إلغاء
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- إدارة القطاعات -->
            <div id="manage-sectors" class="dashboard-section d-none">
                <h2 class="section-title">إدارة القطاعات</h2>
                
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">إضافة قطاع جديد</h5>
                        <form id="add-sector-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">اسم القطاع *</label>
                                    <input type="text" class="form-control" id="sector-name" required>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">رمز القطاع *</label>
                                    <input type="text" class="form-control" id="sector-code" required>
                                    <small class="text-muted">يستخدم في البحث والتصفية</small>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i>إضافة قطاع
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">القطاعات الحالية</h5>
                        <div class="table-responsive">
                            <table class="table table-hover" id="sectors-table">
                                <thead>
                                    <tr>
                                        <th>اسم القطاع</th>
                                        <th>الرمز</th>
                                        <th>عدد المركبات</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- سيتم ملؤها بالبيانات -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- إدارة الألوان -->
            <div id="manage-colors" class="dashboard-section d-none">
                <h2 class="section-title">إدارة الألوان</h2>
                
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">الألوان المستخدمة في النظام</h5>
                        <div id="colors-list" class="row">
                            <!-- سيتم ملؤها بالبيانات -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- إدارة المستخدمين -->
            <div id="manage-users" class="dashboard-section d-none">
                <h2 class="section-title">إدارة المستخدمين</h2>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="users-table">
                                <thead>
                                    <tr>
                                        <th>الاسم</th>
                                        <th>البريد الإلكتروني</th>
                                        <th>الدور</th>
                                        <th>تاريخ التسجيل</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- سيتم ملؤها بالبيانات -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- التطبيق الرئيسي -->
    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCg3Dmf_Odgfm2IL1IZXr_Kl16IaqiWqso",
            authDomain: "verg-micanic.firebaseapp.com",
            databaseURL: "https://verg-micanic-default-rtdb.firebaseio.com",
            projectId: "verg-micanic",
            storageBucket: "verg-micanic.firebasestorage.app",
            messagingSenderId: "881689454596",
            appId: "1:881689454596:web:e630ad9f555ba8feabed51",
            measurementId: "G-B9JZ3CR9GS"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // بيانات التطبيق
        let currentUser = null;
        let sectors = [];
        let vehicles = [];
        let users = [];
        let colors = [];
        
        // تهيئة التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // التحقق من حالة تسجيل الدخول
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    currentUser = user;
                    loadUserData();
                } else {
                    showLogin();
                }
            });
            
            // استعداد نموذج إضافة مركبة
            document.getElementById('add-vehicle-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addVehicle();
            });
            
            // استعداد نموذج إضافة قطاع
            document.getElementById('add-sector-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addSector();
            });
            
            // تحديث معاينة الألوان
            document.getElementById('primary-color').addEventListener('input', function() {
                updateColorPreview('primary-color-preview', this.value);
            });
            
            document.getElementById('secondary-color').addEventListener('input', function() {
                updateColorPreview('secondary-color-preview', this.value);
            });
            
            // تحميل البيانات الأولية
            loadInitialData();
        });
        
        // تسجيل الدخول
        function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error');
            
            if (!email || !password) {
                showError(errorElement, 'يرجى إدخال البريد الإلكتروني وكلمة المرور');
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // تسجيل الدخول ناجح
                    currentUser = userCredential.user;
                    loadUserData();
                    hideError(errorElement);
                })
                .catch((error) => {
                    showError(errorElement, getAuthErrorMessage(error.code));
                });
        }
        
        // تسجيل مستخدم جديد
        function register() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const role = document.getElementById('register-role').value;
            const errorElement = document.getElementById('register-error');
            
            if (!name || !email || !password) {
                showError(errorElement, 'يرجى تعبئة جميع الحقول');
                return;
            }
            
            if (password.length < 6) {
                showError(errorElement, 'كلمة المرور يجب أن تتكون من 6 أحرف على الأقل');
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // حفظ بيانات المستخدم في قاعدة البيانات
                    const user = userCredential.user;
                    const userData = {
                        name: name,
                        email: email,
                        role: role,
                        createdAt: new Date().toISOString()
                    };
                    
                    return database.ref('users/' + user.uid).set(userData);
                })
                .then(() => {
                    // التسجيل ناجح
                    hideError(errorElement);
                    showLogin();
                    alert('تم إنشاء الحساب بنجاح! يمكنك الآن تسجيل الدخول.');
                })
                .catch((error) => {
                    showError(errorElement, getAuthErrorMessage(error.code));
                });
        }
        
        // تسجيل الخروج
        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                showLogin();
            });
        }
        
        // تحميل بيانات المستخدم
        function loadUserData() {
            const userRef = database.ref('users/' + currentUser.uid);
            
            userRef.once('value').then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    // تحديث واجهة المستخدم
                    document.getElementById('user-info').textContent = `مرحباً، ${userData.name}`;
                    
                    // تحديث شارة الدور
                    const roleBadge = document.getElementById('user-role-badge');
                    roleBadge.textContent = getRoleName(userData.role);
                    roleBadge.className = `user-badge badge-${userData.role}`;
                    
                    // التحكم في صلاحيات الوصول
                    updatePermissions(userData.role);
                    
                    // إخفاء صفحة تسجيل الدخول وإظهار لوحة التحكم
                    showDashboard();
                    
                    // تحميل البيانات
                    loadSectors();
                    loadVehicles();
                    loadUsers();
                    extractColorsFromVehicles();
                }
            });
        }
        
        // تحديث الصلاحيات بناءً على دور المستخدم
        function updatePermissions(role) {
            // إخفاء/إظهار العناصر بناءً على الدور
            const adminOnly = ['manage-users-link', 'manage-sectors-link', 'manage-colors-link', 'add-vehicle-link'];
            const editorOnly = ['add-vehicle-link'];
            
            // إخفاء جميع العناصر أولاً
            adminOnly.concat(editorOnly).forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });
            
            // إظهار العناصر بناءً على الدور
            if (role === 'admin') {
                adminOnly.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.style.display = 'block';
                });
            } else if (role === 'editor') {
                editorOnly.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.style.display = 'block';
                });
            }
        }
        
        // تحميل القطاعات
        function loadSectors() {
            database.ref('sectors').once('value').then((snapshot) => {
                sectors = [];
                snapshot.forEach((childSnapshot) => {
                    sectors.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                // تحديث القوائم المنسدلة
                updateSectorDropdowns();
                updateSectorsTable();
            });
        }
        
        // تحميل المركبات
        function loadVehicles() {
            database.ref('vehicles').once('value').then((snapshot) => {
                vehicles = [];
                snapshot.forEach((childSnapshot) => {
                    vehicles.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                // تحديث الإحصائيات
                updateDashboardStats();
                updateRecentVehicles();
                
                // تحديث نتائج البحث
                displayVehicles(vehicles);
            });
        }
        
        // تحميل المستخدمين
        function loadUsers() {
            database.ref('users').once('value').then((snapshot) => {
                users = [];
                snapshot.forEach((childSnapshot) => {
                    users.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                updateUsersTable();
            });
        }
        
        // استخراج الألوان من المركبات
        function extractColorsFromVehicles() {
            colors = [];
            
            vehicles.forEach(vehicle => {
                if (vehicle.primaryColor && !colors.includes(vehicle.primaryColor)) {
                    colors.push(vehicle.primaryColor);
                }
                
                if (vehicle.secondaryColor && !colors.includes(vehicle.secondaryColor)) {
                    colors.push(vehicle.secondaryColor);
                }
            });
            
            updateColorsList();
            updateColorFilter();
        }
        
        // إضافة مركبة جديدة
        function addVehicle() {
            const type = document.getElementById('vehicle-type').value;
            const code = document.getElementById('vehicle-code').value;
            const sector = document.getElementById('vehicle-sector').value;
            const image = document.getElementById('vehicle-image').value;
            const primaryColor = document.getElementById('primary-color').value;
            const secondaryColor = document.getElementById('secondary-color').value;
            const notes = document.getElementById('vehicle-notes').value;
            
            if (!type || !code || !sector || !image || !primaryColor || !secondaryColor) {
                alert('يرجى تعبئة جميع الحقول الإلزامية');
                return;
            }
            
            const vehicleData = {
                type: type,
                code: code,
                sector: sector,
                image: image,
                primaryColor: primaryColor,
                secondaryColor: secondaryColor,
                notes: notes,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.uid
            };
            
            database.ref('vehicles').push(vehicleData)
                .then(() => {
                    alert('تم إضافة المركبة بنجاح');
                    document.getElementById('add-vehicle-form').reset();
                    loadVehicles();
                })
                .catch((error) => {
                    alert('حدث خطأ أثناء إضافة المركبة: ' + error.message);
                });
        }
        
        // إضافة قطاع جديد
        function addSector() {
            const name = document.getElementById('sector-name').value;
            const code = document.getElementById('sector-code').value;
            
            if (!name || !code) {
                alert('يرجى تعبئة جميع الحقول');
                return;
            }
            
            const sectorData = {
                name: name,
                code: code,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.uid
            };
            
            database.ref('sectors').push(sectorData)
                .then(() => {
                    alert('تم إضافة القطاع بنجاح');
                    document.getElementById('add-sector-form').reset();
                    loadSectors();
                })
                .catch((error) => {
                    alert('حدث خطأ أثناء إضافة القطاع: ' + error.message);
                });
        }
        
        // البحث عن المركبات
        function searchVehicles() {
            const type = document.getElementById('search-type').value;
            const sector = document.getElementById('search-sector').value;
            const selectedColors = Array.from(document.querySelectorAll('.color-checkbox:checked')).map(cb => cb.value);
            
            let filteredVehicles = vehicles;
            
            if (type) {
                filteredVehicles = filteredVehicles.filter(v => v.type === type);
            }
            
            if (sector) {
                filteredVehicles = filteredVehicles.filter(v => v.sector === sector);
            }
            
            if (selectedColors.length > 0) {
                filteredVehicles = filteredVehicles.filter(v => 
                    selectedColors.includes(v.primaryColor) || 
                    selectedColors.includes(v.secondaryColor)
                );
            }
            
            displayVehicles(filteredVehicles);
        }
        
        // عرض المركبات
        function displayVehicles(vehiclesToDisplay) {
            const container = document.getElementById('search-results');
            
            if (vehiclesToDisplay.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-car fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">لا توجد مركبات مطابقة للبحث</h4>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            vehiclesToDisplay.forEach(vehicle => {
                const sectorName = getSectorName(vehicle.sector);
                
                html += `
                    <div class="col-md-4 col-sm-6 mb-4">
                        <div class="card vehicle-card h-100">
                            <div class="vehicle-img-container">
                                <img src="${vehicle.image}" class="vehicle-img" alt="${vehicle.type}">
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">${vehicle.type}</h5>
                                <p class="card-text">
                                    <strong>القطاع:</strong> ${sectorName}<br>
                                    <strong>الكود:</strong> ${vehicle.code}<br>
                                    <strong>الألوان:</strong>
                                    <span class="color-preview" style="background-color: #${vehicle.primaryColor};" title="اللون الأول"></span>
                                    <span class="color-preview" style="background-color: #${vehicle.secondaryColor};" title="اللون الثانوي"></span>
                                </p>
                                ${vehicle.notes ? `<p class="card-text"><small>${vehicle.notes}</small></p>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // إعادة تعيين البحث
        function resetSearch() {
            document.getElementById('search-type').value = '';
            document.getElementById('search-sector').value = '';
            document.querySelectorAll('.color-checkbox').forEach(cb => cb.checked = false);
            displayVehicles(vehicles);
        }
        
        // تحديث إحصائيات لوحة التحكم
        function updateDashboardStats() {
            // تعداد المستخدمين حسب الدور
            const adminCount = users.filter(u => u.role === 'admin').length;
            const editorCount = users.filter(u => u.role === 'editor').length;
            const viewerCount = users.filter(u => u.role === 'viewer').length;
            
            document.getElementById('admin-count').textContent = adminCount;
            document.getElementById('editor-count').textContent = editorCount;
            document.getElementById('viewer-count').textContent = viewerCount;
            document.getElementById('vehicle-count').textContent = vehicles.length;
            
            // تحديث الرسم البياني
            updateChart();
        }
        
        // تحديث المركبات الأخيرة
        function updateRecentVehicles() {
            const container = document.getElementById('recent-vehicles');
            const recentVehicles = vehicles.slice(-5).reverse();
            
            if (recentVehicles.length === 0) {
                container.innerHTML = '<p class="text-muted">لا توجد مركبات مضافة بعد</p>';
                return;
            }
            
            let html = '<div class="list-group">';
            
            recentVehicles.forEach(vehicle => {
                const sectorName = getSectorName(vehicle.sector);
                html += `
                    <a href="#" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${vehicle.type}</h6>
                            <small>${formatDate(vehicle.createdAt)}</small>
                        </div>
                        <p class="mb-1">${sectorName} - ${vehicle.code}</p>
                    </a>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // تحديث القوائم المنسدلة للقطاعات
        function updateSectorDropdowns() {
            const searchSector = document.getElementById('search-sector');
            const vehicleSector = document.getElementById('vehicle-sector');
            
            let searchOptions = '<option value="">جميع القطاعات</option>';
            let vehicleOptions = '<option value="">اختر القطاع</option>';
            
            sectors.forEach(sector => {
                searchOptions += `<option value="${sector.id}">${sector.name}</option>`;
                vehicleOptions += `<option value="${sector.id}">${sector.name}</option>`;
            });
            
            searchSector.innerHTML = searchOptions;
            vehicleSector.innerHTML = vehicleOptions;
        }
        
        // تحديث جدول القطاعات
        function updateSectorsTable() {
            const tbody = document.querySelector('#sectors-table tbody');
            
            if (sectors.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center">لا توجد قطاعات مضافة بعد</td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            sectors.forEach(sector => {
                const vehicleCount = vehicles.filter(v => v.sector === sector.id).length;
                
                html += `
                    <tr>
                        <td>${sector.name}</td>
                        <td><code>${sector.code}</code></td>
                        <td>${vehicleCount}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-2">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSector('${sector.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // تحديث قائمة الألوان
        function updateColorsList() {
            const container = document.getElementById('colors-list');
            
            if (colors.length === 0) {
                container.innerHTML = '<p class="text-muted">لا توجد ألوان مسجلة بعد</p>';
                return;
            }
            
            let html = '';
            
            colors.forEach(color => {
                html += `
                    <div class="col-md-3 col-sm-4 col-6 mb-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="color-preview mx-auto mb-2" style="background-color: #${color}; width: 50px; height: 50px;"></div>
                                <h6>#${color}</h6>
                                <small>${countColorUsage(color)} مركبة</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // تحديث فلتر الألوان
        function updateColorFilter() {
            const container = document.getElementById('color-filter');
            
            if (colors.length === 0) {
                container.innerHTML = '<p class="text-muted">لا توجد ألوان مسجلة</p>';
                return;
            }
            
            let html = '<div class="d-flex flex-wrap gap-2">';
            
            colors.forEach(color => {
                html += `
                    <div class="form-check">
                        <input class="form-check-input color-checkbox" type="checkbox" value="${color}" id="color-${color}">
                        <label class="form-check-label d-flex align-items-center" for="color-${color}">
                            <span class="color-preview me-2" style="background-color: #${color};"></span>
                            #${color}
                        </label>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // تحديث جدول المستخدمين
        function updateUsersTable() {
            const tbody = document.querySelector('#users-table tbody');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">لا توجد مستخدمين مسجلين</td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td><span class="user-badge badge-${user.role}">${getRoleName(user.role)}</span></td>
                        <td>${formatDate(user.createdAt)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="editUser('${user.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // تحديث الرسم البياني
        function updateChart() {
            const ctx = document.getElementById('stats-chart').getContext('2d');
            
            // تجميع المركبات حسب النوع
            const vehicleTypes = ["الفورد فكتوريا", "الدودج تشارجر", "فورد اكسبلور", "تاهو"];
            const vehicleCounts = vehicleTypes.map(type => 
                vehicles.filter(v => v.type === type).length
            );
            
            // إذا كان هناك رسم بياني موجود بالفعل، قم بتدميره
            if (window.vehiclesChart) {
                window.vehiclesChart.destroy();
            }
            
            window.vehiclesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: vehicleTypes,
                    datasets: [{
                        label: 'عدد المركبات',
                        data: vehicleCounts,
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.7)',
                            'rgba(231, 76, 60, 0.7)',
                            'rgba(46, 204, 113, 0.7)',
                            'rgba(155, 89, 182, 0.7)'
                        ],
                        borderColor: [
                            'rgb(52, 152, 219)',
                            'rgb(231, 76, 60)',
                            'rgb(46, 204, 113)',
                            'rgb(155, 89, 182)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // مساعدة: الحصول على اسم القطاع من ID
        function getSectorName(sectorId) {
            const sector = sectors.find(s => s.id === sectorId);
            return sector ? sector.name : 'غير معروف';
        }
        
        // مساعدة: الحصول على اسم الدور
        function getRoleName(roleCode) {
            const roles = {
                'admin': 'مدير',
                'editor': 'محرر',
                'viewer': 'مشاهد'
            };
            return roles[roleCode] || roleCode;
        }
        
        // مساعدة: عد استخدامات اللون
        function countColorUsage(color) {
            return vehicles.filter(v => 
                v.primaryColor === color || v.secondaryColor === color
            ).length;
        }
        
        // مساعدة: تحديث معاينة اللون
        function updateColorPreview(elementId, colorValue) {
            const element = document.getElementById(elementId);
            if (element && colorValue) {
                element.style.backgroundColor = '#' + colorValue;
            }
        }
        
        // مساعدة: تنسيق التاريخ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-EG');
        }
        
        // مساعدة: عرض رسالة خطأ
        function showError(element, message) {
            element.textContent = message;
            element.classList.remove('d-none');
        }
        
        // مساعدة: إخفاء رسالة الخطأ
        function hideError(element) {
            element.classList.add('d-none');
        }
        
        // مساعدة: تحويل رسالة خطأ Firebase
        function getAuthErrorMessage(errorCode) {
            const messages = {
                'auth/invalid-email': 'البريد الإلكتروني غير صالح',
                'auth/user-disabled': 'هذا الحساب معطل',
                'auth/user-not-found': 'لا يوجد حساب بهذا البريد الإلكتروني',
                'auth/wrong-password': 'كلمة المرور غير صحيحة',
                'auth/email-already-in-use': 'البريد الإلكتروني مستخدم بالفعل',
                'auth/weak-password': 'كلمة المرور ضعيفة، يجب أن تتكون من 6 أحرف على الأقل',
                'auth/operation-not-allowed': 'عملية التسجيل غير مسموحة حالياً'
            };
            
            return messages[errorCode] || 'حدث خطأ غير معروف، يرجى المحاولة مرة أخرى';
        }
        
        // التحكم في عرض الأقسام
        function showSection(sectionId) {
            // إخفاء جميع الأقسام
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.add('d-none');
            });
            
            // إزالة النشط من جميع عناصر القائمة
            document.querySelectorAll('.sidebar a').forEach(link => {
                link.classList.remove('active');
            });
            
            // إظهار القسم المطلوب
            document.getElementById(sectionId).classList.remove('d-none');
            
            // إضافة النشط إلى العنصر المناسب في القائمة الجانبية
            const activeLink = Array.from(document.querySelectorAll('.sidebar a')).find(link => 
                link.textContent.includes(getSectionName(sectionId))
            );
            
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }
        
        // الحصول على اسم القسم من الـ ID
        function getSectionName(sectionId) {
            const sections = {
                'dashboard-home': 'لوحة التحكم',
                'search-vehicles': 'بحث المركبات',
                'add-vehicle': 'إضافة مركبة',
                'manage-sectors': 'إدارة القطاعات',
                'manage-colors': 'إدارة الألوان',
                'manage-users': 'إدارة المستخدمين'
            };
            
            return sections[sectionId] || '';
        }
        
        // تبديل شريط التنقل الجانبي (للأجهزة المحمولة)
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }
        
        // إظهار صفحة تسجيل الدخول
        function showLogin() {
            document.getElementById('login-page').classList.remove('d-none');
            document.getElementById('register-page').classList.add('d-none');
            document.getElementById('dashboard').classList.add('d-none');
        }
        
        // إظهار صفحة التسجيل
        function showRegister() {
            document.getElementById('login-page').classList.add('d-none');
            document.getElementById('register-page').classList.remove('d-none');
            document.getElementById('dashboard').classList.add('d-none');
        }
        
        // إظهار لوحة التحكم
        function showDashboard() {
            document.getElementById('login-page').classList.add('d-none');
            document.getElementById('register-page').classList.add('d-none');
            document.getElementById('dashboard').classList.remove('d-none');
            showSection('dashboard-home');
        }
        
        // تحميل البيانات الأولية للقطاعات (إذا لم تكن موجودة)
        function loadInitialData() {
            // هذه بيانات افتراضية للقطاعات (يمكن إضافتها يدوياً)
            const initialSectors = [
                { name: "إدارة الشرطة", code: "police" },
                { name: "أمن الموانئ", code: "ports" },
                { name: "وزارة الصحة", code: "health" }
            ];
            
            // هذه بيانات افتراضية للمركبات من طلبك
            const initialVehicles = [
                {
                    type: "تاهو",
                    code: "rematahoe15",
                    sector: "initial-police",
                    image: "http://i.epvpimg.com/zr6gaab.png",
                    primaryColor: "4c4c4c",
                    secondaryColor: "FFFFFF",
                    notes: "تاهو قيادة إدارة الشرطة"
                },
                {
                    type: "الفورد فكتوريا",
                    code: "cvpi_sign_1",
                    sector: "initial-police",
                    image: "http://i.epvpimg.com/R59idab.png",
                    primaryColor: "4c4c4c",
                    secondaryColor: "FFFFFF",
                    notes: "فورد إدارة الشرطة"
                },
                {
                    type: "تاهو",
                    code: "rematahoe15",
                    sector: "initial-ports",
                    image: "http://i.epvpimg.com/HIl1fab.jpg",
                    primaryColor: "99d24f",
                    secondaryColor: "FFFFFF",
                    notes: "تاهو امن موانئ"
                },
                {
                    type: "تاهو",
                    code: "rematahoe15",
                    sector: "initial-health",
                    image: "http://i.epvpimg.com/Ay3Hbab.jpg",
                    primaryColor: "880000",
                    secondaryColor: "880000",
                    notes: "تاهو وزارة الصحة"
                }
            ];
            
            // التحقق مما إذا كانت القطاعات موجودة بالفعل
            database.ref('sectors').once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    // إضافة القطاعات الافتراضية
                    initialSectors.forEach((sector, index) => {
                        database.ref('sectors/initial-' + sector.code).set({
                            name: sector.name,
                            code: sector.code,
                            createdAt: new Date().toISOString(),
                            createdBy: 'system'
                        });
                    });
                }
            });
        }
        
        // وظائف إضافية للتحكم (يمكن تطويرها)
        function deleteSector(sectorId) {
            if (confirm('هل أنت متأكد من حذف هذا القطاع؟')) {
                database.ref('sectors/' + sectorId).remove()
                    .then(() => {
                        alert('تم حذف القطاع بنجاح');
                        loadSectors();
                    })
                    .catch((error) => {
                        alert('حدث خطأ أثناء حذف القطاع: ' + error.message);
                    });
            }
        }
        
        function editUser(userId) {
            alert('ميزة التعديل قيد التطوير');
        }
        
        function deleteUser(userId) {
            if (confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
                database.ref('users/' + userId).remove()
                    .then(() => {
                        alert('تم حذف المستخدم بنجاح');
                        loadUsers();
                    })
                    .catch((error) => {
                        alert('حدث خطأ أثناء حذف المستخدم: ' + error.message);
                    });
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ø´Ø±Ø·ÙŠØ©</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <style>
        /* Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ */
        /* ... (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ù†Ù…Ø§Ø· ÙƒÙ…Ø§ Ù‡ÙŠ) ... */
        
        .color-picker-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            z-index: 10000;
            display: none;
        }
        
        .color-picker-popup.active {
            display: block;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            display: none;
        }
        
        .overlay.active {
            display: block;
        }
        
        .sector-ranks-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .rank-checkbox-item {
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .rank-checkbox-item:last-child {
            border-bottom: none;
        }
        
        .assigned-ranks {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .assigned-rank-badge {
            background: #e3f2fd;
            color: #1565c0;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <!-- ... (Ù†ÙØ³ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø§ Ù‡ÙŠ) ... -->

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <div id="dashboard" class="d-none">
        <!-- ... (Ù†ÙØ³ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³ÙŠØ·Ø©) ... -->
        
        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <div class="main-content" id="main-content">
            <!-- ========== Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ========== -->
            <!-- ... (Ù†ÙØ³ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…) ... -->
            
            <!-- ========== Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø« ========== -->
            <div id="search-vehicles" class="dashboard-section d-none">
                <h2 class="section-title">
                    <i class="fas fa-search me-2"></i>Ø¨Ø­Ø« Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª
                </h2>
                
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="fas fa-filter me-2 text-primary"></i>ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
                        </h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Ø§Ù„Ù‚Ø·Ø§Ø¹ *</label>
                                <select class="form-control" id="search-sector" required onchange="updateRanksForSector('search')">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø·Ø§Ø¹</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Ø§Ù„Ø±ØªØ¨Ø© *</label>
                                <select class="form-control" id="search-rank" required>
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø±ØªØ¨Ø©</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</label>
                                <select class="form-control" id="search-type">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                                    <option value="ØªØ§Ù‡Ùˆ">ØªØ§Ù‡Ùˆ</option>
                                    <option value="Ø§Ù„ÙÙˆØ±Ø¯ ÙÙƒØªÙˆØ±ÙŠØ§">Ø§Ù„ÙÙˆØ±Ø¯ ÙÙƒØªÙˆØ±ÙŠØ§</option>
                                    <option value="ÙÙˆØ±Ø¯ Ø§ÙƒØ³Ø¨Ù„ÙˆØ±">ÙÙˆØ±Ø¯ Ø§ÙƒØ³Ø¨Ù„ÙˆØ±</option>
                                    <option value="Ø§Ù„Ø¯ÙˆØ¯Ø¬ ØªØ´Ø§Ø±Ø¬Ø±">Ø§Ù„Ø¯ÙˆØ¯Ø¬ ØªØ´Ø§Ø±Ø¬Ø±</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                            <button class="btn btn-primary px-4" onclick="searchVehicles()">
                                <i class="fas fa-search me-2"></i>Ø¨Ø­Ø«
                            </button>
                            <button class="btn btn-outline-secondary px-4" onclick="resetSearch()">
                                <i class="fas fa-redo me-2"></i>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="row" id="search-results">
                    <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« -->
                </div>
            </div>
            
            <!-- ========== Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙƒØ¨Ø© Ø¬Ø¯ÙŠØ¯Ø© ========== -->
            <div id="add-vehicle" class="dashboard-section d-none">
                <h2 class="section-title">
                    <i class="fas fa-car me-2"></i>Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…Ø±ÙƒØ¨Ø©
                </h2>
                
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <form id="vehicle-form" onsubmit="saveVehicle(event)">
                            <input type="hidden" id="vehicle-id">
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© *</label>
                                    <select class="form-control" id="vehicle-type" required onchange="updateVehicleCode()">
                                        <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</option>
                                        <option value="ØªØ§Ù‡Ùˆ">ØªØ§Ù‡Ùˆ</option>
                                        <option value="Ø§Ù„ÙÙˆØ±Ø¯ ÙÙƒØªÙˆØ±ÙŠØ§">Ø§Ù„ÙÙˆØ±Ø¯ ÙÙƒØªÙˆØ±ÙŠØ§</option>
                                        <option value="ÙÙˆØ±Ø¯ Ø§ÙƒØ³Ø¨Ù„ÙˆØ±">ÙÙˆØ±Ø¯ Ø§ÙƒØ³Ø¨Ù„ÙˆØ±</option>
                                        <option value="Ø§Ù„Ø¯ÙˆØ¯Ø¬ ØªØ´Ø§Ø±Ø¬Ø±">Ø§Ù„Ø¯ÙˆØ¯Ø¬ ØªØ´Ø§Ø±Ø¬Ø±</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© *</label>
                                    <input type="text" class="form-control" id="vehicle-code" required readonly>
                                    <small class="text-muted">ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©</small>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø§Ù„Ù‚Ø·Ø§Ø¹ *</label>
                                    <select class="form-control" id="vehicle-sector" required onchange="updateRanksForSector('vehicle')">
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø·Ø§Ø¹</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø§Ù„Ø±ØªØ¨Ø© *</label>
                                    <select class="form-control" id="vehicle-rank" required>
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø±ØªØ¨Ø©</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ÙˆÙ„ *</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="vehicle-color1" placeholder="Ù…Ø«Ø§Ù„: 4c4c4c" required>
                                        <span class="input-group-text color-preview" id="color1-preview"></span>
                                        <button type="button" class="btn btn-outline-secondary" onclick="openColorPicker('vehicle-color1')">
                                            <i class="fas fa-eye-dropper"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ *</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="vehicle-color2" placeholder="Ù…Ø«Ø§Ù„: FFFFFF" required>
                                        <span class="input-group-text color-preview" id="color2-preview"></span>
                                        <button type="button" class="btn btn-outline-secondary" onclick="openColorPicker('vehicle-color2')">
                                            <i class="fas fa-eye-dropper"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© *</label>
                                    <input type="url" class="form-control" id="vehicle-image" required>
                                    <small class="text-muted">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ https://</small>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©</label>
                                    <button type="button" class="btn btn-outline-info w-100" onclick="previewImage()">
                                        <i class="fas fa-image"></i> Ù…Ø¹Ø§ÙŠÙ†Ø©
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                                <textarea class="form-control" id="vehicle-notes" rows="3"></textarea>
                            </div>
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="submit" class="btn btn-primary" id="save-vehicle-btn">
                                    <i class="fas fa-save me-2"></i>Ø­ÙØ¸ ÙÙŠ Firebase
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="resetVehicleForm()">
                                    <i class="fas fa-times me-2"></i>Ø¥Ù„ØºØ§Ø¡
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª ÙˆØ§Ù„Ø±ØªØ¨ ========== -->
            <div id="manage-sectors" class="dashboard-section d-none">
                <h2 class="section-title">
                    <i class="fas fa-list me-2"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª ÙˆØ§Ù„Ø±ØªØ¨
                </h2>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-plus-circle me-2 text-success"></i>Ø¥Ø¶Ø§ÙØ© Ù‚Ø·Ø§Ø¹ Ø¬Ø¯ÙŠØ¯
                                </h5>
                                <form id="sector-form" onsubmit="saveSector(event)">
                                    <input type="hidden" id="sector-id">
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø§Ø¹ *</label>
                                        <input type="text" class="form-control" id="sector-name" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Ø±Ù…Ø² Ø§Ù„Ù‚Ø·Ø§Ø¹ *</label>
                                        <input type="text" class="form-control" id="sector-code" required>
                                        <small class="text-muted">ÙŠØ³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
                                        <textarea class="form-control" id="sector-description" rows="2"></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Ø§Ù„Ø±ØªØ¨ Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ù‚Ø·Ø§Ø¹</label>
                                        <div class="sector-ranks-container">
                                            <div id="sector-ranks-checkboxes">
                                                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ø±ØªØ¨ Ø§Ù„Ù…ØªØ§Ø­Ø© -->
                                            </div>
                                            <div class="assigned-ranks" id="assigned-ranks-preview">
                                                <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±ØªØ¨ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary" id="save-sector-btn">
                                            <i class="fas fa-save me-2"></i>Ø­ÙØ¸ ÙÙŠ Firebase
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-plus-circle me-2 text-success"></i>Ø¥Ø¶Ø§ÙØ© Ø±ØªØ¨Ø© Ø¬Ø¯ÙŠØ¯Ø©
                                </h5>
                                <form id="rank-form" onsubmit="saveRank(event)">
                                    <input type="hidden" id="rank-id">
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø±ØªØ¨Ø© *</label>
                                        <input type="text" class="form-control" id="rank-name" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Ø±Ù…Ø² Ø§Ù„Ø±ØªØ¨Ø© *</label>
                                        <input type="text" class="form-control" id="rank-code" required>
                                        <small class="text-muted">ÙŠØ³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
                                        <textarea class="form-control" id="rank-description" rows="2"></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©</label>
                                        <div class="sector-ranks-container">
                                            <div id="rank-sectors-checkboxes">
                                                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© -->
                                            </div>
                                            <div class="assigned-ranks" id="assigned-sectors-preview">
                                                <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary" id="save-rank-btn">
                                            <i class="fas fa-save me-2"></i>Ø­ÙØ¸ ÙÙŠ Firebase
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-list-alt me-2 text-primary"></i>Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                                </h5>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                                <th>Ø§Ù„Ø±Ù…Ø²</th>
                                                <th>Ø§Ù„Ø±ØªØ¨ Ø§Ù„ØªØ§Ø¨Ø¹Ø©</th>
                                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                            </tr>
                                        </thead>
                                        <tbody id="sectors-list">
                                            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-list-alt me-2 text-primary"></i>Ø§Ù„Ø±ØªØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                                </h5>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                                <th>Ø§Ù„Ø±Ù…Ø²</th>
                                                <th>Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©</th>
                                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ranks-list">
                                            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ========== -->
            <div id="manage-users" class="dashboard-section d-none">
                <h2 class="section-title">
                    <i class="fas fa-users me-2"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                </h2>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-user-plus me-2 text-success"></i>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                                </h5>
                                <form id="user-form" onsubmit="saveUser(event)">
                                    <input type="hidden" id="user-id">
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
                                        <input type="text" class="form-control" id="user-name" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ *</label>
                                        <input type="email" class="form-control" id="user-email" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± *</label>
                                        <input type="password" class="form-control" id="user-password">
                                        <small class="text-muted">Ø§ØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… *</label>
                                        <select class="form-control" id="user-role" required>
                                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±</option>
                                            <option value="admin">Ù…Ø¯ÙŠØ±</option>
                                            <option value="editor">Ù…Ø­Ø±Ø±</option>
                                            <option value="viewer">Ù…Ø´Ø§Ù‡Ø¯</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©</label>
                                        <select class="form-control" id="user-sectors" multiple>
                                            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª -->
                                        </select>
                                        <small class="text-muted">Ø§Ø¶ØºØ· Ctrl Ù„Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ù‚Ø·Ø§Ø¹</small>
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary" id="save-user-btn">
                                            <i class="fas fa-save me-2"></i>Ø­ÙØ¸ ÙÙŠ Firebase
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-users me-2 text-primary"></i>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙˆÙ†
                                </h5>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                                                <th>Ø§Ù„Ø¯ÙˆØ±</th>
                                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                            </tr>
                                        </thead>
                                        <tbody id="users-list">
                                            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ========== Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ========== -->
            <!-- ... (Ù†ÙØ³ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…) ... -->
            
            <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ø£Ù„ÙˆØ§Ù†) -->
            <div id="system-tools" class="dashboard-section d-none">
                <!-- ... (Ù†ÙØ³ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…) ... -->
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
    <div id="color-picker-overlay" class="overlay"></div>
    <div id="color-picker-popup" class="color-picker-popup">
        <h5>Ø§Ø®ØªØ± Ù„ÙˆÙ†</h5>
        <div class="color-grid mt-3" id="color-grid">
            <!-- Ø£Ù„ÙˆØ§Ù† Ø§ÙØªØ±Ø§Ø¶ÙŠØ© -->
        </div>
        <div class="mt-3">
            <input type="color" id="custom-color-picker" class="form-control">
        </div>
        <div class="d-flex justify-content-between mt-3">
            <button class="btn btn-primary" onclick="applySelectedColor()">ØªØ·Ø¨ÙŠÙ‚</button>
            <button class="btn btn-secondary" onclick="closeColorPicker()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <!-- Ù…ÙƒØªØ¨Ø§Øª Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCg3Dmf_Odgfm2IL1IZXr_Kl16IaqiWqso",
            authDomain: "verg-micanic.firebaseapp.com",
            databaseURL: "https://verg-micanic-default-rtdb.firebaseio.com",
            projectId: "verg-micanic",
            storageBucket: "verg-micanic.firebasestorage.app",
            messagingSenderId: "881689454596",
            appId: "1:881689454596:web:e630ad9f555ba8feabed51",
            measurementId: "G-B9JZ3CR9GS"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        let currentUser = null;
        let userRole = null;
        let vehicles = [];
        let sectors = [];
        let ranks = [];
        let users = [];
        let firebaseInitialized = true;
        let chart = null;
        let dataListeners = [];
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ù„ÙˆØ§Ù†
        let currentColorField = '';
        let selectedColor = '';

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ø­Ø³Ù†Ø©
        const defaultData = {
            sectors: [
                { 
                    name: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±Ø·Ø©', 
                    code: 'police', 
                    description: 'Ù…Ø±ÙƒØ¨Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±Ø·Ø©',
                    ranks: ['lieutenant', 'captain', 'major', 'lt-colonel', 'colonel']
                },
                { 
                    name: 'Ø£Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ù†Ø¦', 
                    code: 'ports', 
                    description: 'Ù…Ø±ÙƒØ¨Ø§Øª Ø£Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ù†Ø¦',
                    ranks: ['lieutenant', 'captain', 'major']
                },
                { 
                    name: 'ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø©', 
                    code: 'health', 
                    description: 'Ù…Ø±ÙƒØ¨Ø§Øª ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø©',
                    ranks: ['lieutenant', 'captain', 'major']
                }
            ],
            ranks: [
                { name: 'Ù…Ù„Ø§Ø²Ù…', code: 'lieutenant', description: 'Ø±ØªØ¨Ø© Ù…Ù„Ø§Ø²Ù…', sectors: ['police', 'ports', 'health'] },
                { name: 'Ù†Ù‚ÙŠØ¨', code: 'captain', description: 'Ø±ØªØ¨Ø© Ù†Ù‚ÙŠØ¨', sectors: ['police', 'ports', 'health'] },
                { name: 'Ø±Ø§Ø¦Ø¯', code: 'major', description: 'Ø±ØªØ¨Ø© Ø±Ø§Ø¦Ø¯', sectors: ['police', 'ports', 'health'] },
                { name: 'Ù…Ù‚Ø¯Ù…', code: 'lt-colonel', description: 'Ø±ØªØ¨Ø© Ù…Ù‚Ø¯Ù…', sectors: ['police', 'ports'] },
                { name: 'Ø¹Ù‚ÙŠØ¯', code: 'colonel', description: 'Ø±ØªØ¨Ø© Ø¹Ù‚ÙŠØ¯', sectors: ['police'] }
            ],
            users: [
                {
                    name: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ',
                    email: 'admin@test.com',
                    role: 'admin',
                    permissions: ['all'],
                    createdAt: new Date().toISOString(),
                    sectors: ['police', 'ports', 'health']
                }
            ],
            vehicles: [
                {
                    type: 'ØªØ§Ù‡Ùˆ',
                    code: 'rematahoe15',
                    sector: 'police',
                    rank: 'captain',
                    color1: '4c4c4c',
                    color2: 'FFFFFF',
                    image: 'https://i.epvpimg.com/zr6gaab.png',
                    notes: 'ØªØ§Ù‡Ùˆ Ù‚ÙŠØ§Ø¯Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±Ø·Ø©'
                },
                {
                    type: 'Ø§Ù„ÙÙˆØ±Ø¯ ÙÙƒØªÙˆØ±ÙŠØ§',
                    code: 'cvpi_sign_1',
                    sector: 'police',
                    rank: 'major',
                    color1: '4c4c4c',
                    color2: 'FFFFFF',
                    image: 'https://i.epvpimg.com/R59idab.png',
                    notes: 'ÙÙˆØ±Ø¯ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±Ø·Ø©'
                },
                {
                    type: 'ÙÙˆØ±Ø¯ Ø§ÙƒØ³Ø¨Ù„ÙˆØ±',
                    code: 'remap16expl',
                    sector: 'police',
                    rank: 'lieutenant',
                    color1: '4c4c4c',
                    color2: 'FFFFFF',
                    image: 'https://i.epvpimg.com/e3hDdab.png',
                    notes: 'ÙÙˆØ±Ø¯ Ø§ÙƒØ³Ø¨Ù„ÙˆØ± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±Ø·Ø©'
                },
                {
                    type: 'Ø§Ù„Ø¯ÙˆØ¯Ø¬ ØªØ´Ø§Ø±Ø¬Ø±',
                    code: 'alphatexture',
                    sector: 'ports',
                    rank: 'lt-colonel',
                    color1: '99d24f',
                    color2: 'FFFFFF',
                    image: 'https://i.epvpimg.com/aPQtdab.png',
                    notes: 'Ø¯ÙˆØ¯Ø¬ Ø£Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ù†Ø¦'
                },
                {
                    type: 'ØªØ§Ù‡Ùˆ',
                    code: 'rematahoe15',
                    sector: 'health',
                    rank: 'colonel',
                    color1: '880000',
                    color2: '880000',
                    image: 'https://i.epvpimg.com/Ay3Hbab.jpg',
                    notes: 'ØªØ§Ù‡Ùˆ ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø©'
                }
            ]
        };

        // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… - Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„');
            console.log('ğŸ”¥ Firebase Ù…Ù‡ÙŠØ£: ', firebaseInitialized);
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            updateConnectionStatus();
            
            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§ØªØµØ§Ù„ Firebase
            monitorFirebaseConnection();
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            setupEventListeners();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            checkAuthState();
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            setupColorPicker();
        });

        // ========== Ø¯ÙˆØ§Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø­Ø³Ù†Ø© ==========
        
        // 1. ØªØ­Ø¯ÙŠØ« ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
        function updateVehicleCode() {
            const vehicleType = document.getElementById('vehicle-type').value;
            const codeInput = document.getElementById('vehicle-code');
            
            const vehicleCodes = {
                'ØªØ§Ù‡Ùˆ': 'rematahoe15',
                'Ø§Ù„ÙÙˆØ±Ø¯ ÙÙƒØªÙˆØ±ÙŠØ§': 'cvpi_sign_1',
                'ÙÙˆØ±Ø¯ Ø§ÙƒØ³Ø¨Ù„ÙˆØ±': 'remap16expl',
                'Ø§Ù„Ø¯ÙˆØ¯Ø¬ ØªØ´Ø§Ø±Ø¬Ø±': 'alphatexture'
            };
            
            if (vehicleCodes[vehicleType]) {
                codeInput.value = vehicleCodes[vehicleType];
            } else {
                codeInput.value = '';
            }
        }
        
        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø·Ø§Ø¹
        function updateRanksForSector(context) {
            const sectorId = document.getElementById(`${context}-sector`).value;
            const rankSelect = document.getElementById(`${context}-rank`);
            
            if (!sectorId) {
                rankSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø±ØªØ¨Ø©</option>';
                return;
            }
            
            const sector = sectors.find(s => s.id === sectorId);
            if (!sector || !sector.ranks) {
                rankSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø±ØªØ¨Ø©</option>';
                return;
            }
            
            let options = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø±ØªØ¨Ø©</option>';
            
            ranks.forEach(rank => {
                if (sector.ranks.includes(rank.id) || sector.ranks.includes(rank.code)) {
                    options += `<option value="${rank.id}">${rank.name}</option>`;
                }
            });
            
            rankSelect.innerHTML = options;
        }
        
        // 3. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ØªØ¨ ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª
        function loadRanksForSectorManagement() {
            const container = document.getElementById('sector-ranks-checkboxes');
            if (!container) return;
            
            let html = '';
            ranks.forEach(rank => {
                html += `
                    <div class="form-check rank-checkbox-item">
                        <input class="form-check-input rank-checkbox" type="checkbox" 
                               value="${rank.id}" id="rank-${rank.id}"
                               onchange="updateAssignedRanksPreview()">
                        <label class="form-check-label" for="rank-${rank.id}">
                            ${rank.name} (${rank.code})
                        </label>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 4. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±ØªØ¨
        function loadSectorsForRankManagement() {
            const container = document.getElementById('rank-sectors-checkboxes');
            if (!container) return;
            
            let html = '';
            sectors.forEach(sector => {
                html += `
                    <div class="form-check rank-checkbox-item">
                        <input class="form-check-input sector-checkbox" type="checkbox" 
                               value="${sector.id}" id="sector-${sector.id}"
                               onchange="updateAssignedSectorsPreview()">
                        <label class="form-check-label" for="sector-${sector.id}">
                            ${sector.name} (${sector.code})
                        </label>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 5. ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø±ØªØ¨ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        function updateAssignedRanksPreview() {
            const container = document.getElementById('assigned-ranks-preview');
            if (!container) return;
            
            const selectedRanks = [];
            document.querySelectorAll('.rank-checkbox:checked').forEach(cb => {
                const rankId = cb.value;
                const rank = ranks.find(r => r.id === rankId);
                if (rank) {
                    selectedRanks.push(rank.name);
                }
            });
            
            container.innerHTML = selectedRanks.map(name => 
                `<span class="assigned-rank-badge">${name}</span>`
            ).join('');
        }
        
        // 6. ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        function updateAssignedSectorsPreview() {
            const container = document.getElementById('assigned-sectors-preview');
            if (!container) return;
            
            const selectedSectors = [];
            document.querySelectorAll('.sector-checkbox:checked').forEach(cb => {
                const sectorId = cb.value;
                const sector = sectors.find(s => s.id === sectorId);
                if (sector) {
                    selectedSectors.push(sector.name);
                }
            });
            
            container.innerHTML = selectedSectors.map(name => 
                `<span class="assigned-rank-badge">${name}</span>`
            ).join('');
        }
        
        // 7. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        function loadSectorsForUserManagement() {
            const select = document.getElementById('user-sectors');
            if (!select) return;
            
            let options = '';
            sectors.forEach(sector => {
                options += `<option value="${sector.id}">${sector.name}</option>`;
            });
            
            select.innerHTML = options;
        }
        
        // 8. Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        function saveRank(event) {
            event.preventDefault();
            
            if (!currentUser) {
                showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            
            const rankId = document.getElementById('rank-id').value;
            const name = document.getElementById('rank-name').value;
            const code = document.getElementById('rank-code').value;
            const description = document.getElementById('rank-description').value;
            
            if (!name || !code) {
                showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
                return;
            }
            
            // Ø¬Ù…Ø¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            const selectedSectors = [];
            document.querySelectorAll('.sector-checkbox:checked').forEach(cb => {
                selectedSectors.push(cb.value);
            });
            
            const rankData = {
                name,
                code,
                description: description || '',
                sectors: selectedSectors,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.uid
            };
            
            showLoading('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø±ØªØ¨Ø© ÙÙŠ Firebase...');
            
            if (rankId) {
                database.ref('ranks/' + rankId).update(rankData)
                    .then(() => {
                        hideLoading();
                        showToast('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Firebase', 'success');
                        resetRankForm();
                        updateLastUpdateTime();
                    })
                    .catch((error) => {
                        hideLoading();
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØªØ¨Ø©:', error);
                        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    });
            } else {
                rankData.createdAt = new Date().toISOString();
                rankData.createdBy = currentUser.uid;
                
                database.ref('ranks').push(rankData)
                    .then(() => {
                        hideLoading();
                        showToast('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Firebase', 'success');
                        resetRankForm();
                        updateLastUpdateTime();
                    })
                    .catch((error) => {
                        hideLoading();
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØªØ¨Ø©:', error);
                        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    });
            }
        }
        
        // 9. Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function saveUser(event) {
            event.preventDefault();
            
            if (!currentUser) {
                showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            
            const userId = document.getElementById('user-id').value;
            const name = document.getElementById('user-name').value;
            const email = document.getElementById('user-email').value;
            const password = document.getElementById('user-password').value;
            const role = document.getElementById('user-role').value;
            
            // Ø¬Ù…Ø¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            const selectedSectors = Array.from(document.getElementById('user-sectors').selectedOptions)
                .map(option => option.value);
            
            if (!name || !email || !role) {
                showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
                return;
            }
            
            showLoading('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...');
            
            const userData = {
                name,
                email,
                role,
                sectors: selectedSectors,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.uid
            };
            
            if (userId) {
                // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯
                const promises = [];
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase Database
                promises.push(database.ref('users/' + userId).update(userData));
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©ØŒ ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ÙÙŠ Authentication
                if (password) {
                    promises.push(auth.updatePassword(userId, password));
                }
                
                Promise.all(promises)
                    .then(() => {
                        hideLoading();
                        showToast('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        resetUserForm();
                        updateLastUpdateTime();
                    })
                    .catch((error) => {
                        hideLoading();
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    });
            } else {
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                if (!password) {
                    showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯', 'error');
                    hideLoading();
                    return;
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Auth
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const newUserId = userCredential.user.uid;
                        
                        // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firebase Database
                        userData.createdAt = new Date().toISOString();
                        userData.createdBy = currentUser.uid;
                        
                        return database.ref('users/' + newUserId).set(userData);
                    })
                    .then(() => {
                        hideLoading();
                        showToast('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                        resetUserForm();
                        updateLastUpdateTime();
                        
                        // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                        auth.signOut().then(() => {
                            auth.signInWithEmailAndPassword(currentUser.email, '123456');
                        });
                    })
                    .catch((error) => {
                        hideLoading();
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                        showToast(getAuthErrorMessage(error.code), 'error');
                    });
            }
        }
        
        // 10. ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        function updateUsersList() {
            const container = document.getElementById('users-list');
            if (!container) return;
            
            let html = '';
            
            users.forEach(user => {
                let sectorsText = '';
                if (user.sectors && user.sectors.length > 0) {
                    sectorsText = user.sectors.map(sectorId => {
                        const sector = sectors.find(s => s.id === sectorId);
                        return sector ? sector.name : sectorId;
                    }).join(', ');
                }
                
                html += `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td><span class="badge bg-${user.role === 'admin' ? 'danger' : user.role === 'editor' ? 'warning' : 'success'}">${getRoleName(user.role)}</span></td>
                        <td>
                            <small class="text-muted">${sectorsText || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª'}</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="editUser('${user.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.id}')" ${user.id === currentUser?.uid ? 'disabled' : ''}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 11. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('user-id').value = user.id;
            document.getElementById('user-name').value = user.name;
            document.getElementById('user-email').value = user.email;
            document.getElementById('user-role').value = user.role;
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            const sectorsSelect = document.getElementById('user-sectors');
            Array.from(sectorsSelect.options).forEach(option => {
                option.selected = user.sectors && user.sectors.includes(option.value);
            });
            
            showSection('manage-users');
        }
        
        // 12. Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function deleteUser(userId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
            
            // Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
            if (userId === currentUser?.uid) {
                showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ', 'error');
                return;
            }
            
            showLoading('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...');
            
            // Ø­Ø°Ù Ù…Ù† Authentication
            auth.deleteUser(userId)
                .then(() => {
                    // Ø­Ø°Ù Ù…Ù† Database
                    return database.ref('users/' + userId).remove();
                })
                .then(() => {
                    hideLoading();
                    showToast('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                })
                .catch((error) => {
                    hideLoading();
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
                });
        }
        
        // 13. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø·Ø§Ø¹
        function editSector(sectorId) {
            const sector = sectors.find(s => s.id === sectorId);
            if (!sector) return;
            
            document.getElementById('sector-id').value = sector.id;
            document.getElementById('sector-name').value = sector.name;
            document.getElementById('sector-code').value = sector.code;
            document.getElementById('sector-description').value = sector.description || '';
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±ØªØ¨ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            const rankCheckboxes = document.querySelectorAll('.rank-checkbox');
            rankCheckboxes.forEach(cb => {
                cb.checked = sector.ranks && sector.ranks.includes(cb.value);
            });
            
            updateAssignedRanksPreview();
            
            showSection('manage-sectors');
        }
        
        // 14. ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØªØ¨Ø©
        function editRank(rankId) {
            const rank = ranks.find(r => r.id === rankId);
            if (!rank) return;
            
            document.getElementById('rank-id').value = rank.id;
            document.getElementById('rank-name').value = rank.name;
            document.getElementById('rank-code').value = rank.code;
            document.getElementById('rank-description').value = rank.description || '';
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            const sectorCheckboxes = document.querySelectorAll('.sector-checkbox');
            sectorCheckboxes.forEach(cb => {
                cb.checked = rank.sectors && rank.sectors.includes(cb.value);
            });
            
            updateAssignedSectorsPreview();
            
            showSection('manage-sectors');
        }
        
        // 15. Ø­Ø°Ù Ø§Ù„Ø±ØªØ¨Ø©
        function deleteRank(rankId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±ØªØ¨Ø©ØŸ')) return;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±ØªØ¨Ø© Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø£ÙŠ Ù…Ø±ÙƒØ¨Ø©
            const isUsed = vehicles.some(v => v.rank === rankId || v.rankId === rankId);
            if (isUsed) {
                showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±ØªØ¨Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø³ØªØ®Ø¯Ù…Ø© ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª', 'error');
                return;
            }
            
            database.ref('ranks/' + rankId).remove()
                .then(() => {
                    showToast('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±ØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                })
                .catch((error) => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø±ØªØ¨Ø©:', error);
                    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø±ØªØ¨Ø©', 'error');
                });
        }
        
        // 16. ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±ØªØ¨
        function updateRanksList() {
            const container = document.getElementById('ranks-list');
            if (!container) return;
            
            let html = '';
            
            ranks.forEach(rank => {
                let sectorsText = '';
                if (rank.sectors && rank.sectors.length > 0) {
                    sectorsText = rank.sectors.map(sectorId => {
                        const sector = sectors.find(s => s.id === sectorId);
                        return sector ? sector.name : sectorId;
                    }).join(', ');
                }
                
                html += `
                    <tr>
                        <td>${rank.name}</td>
                        <td><code>${rank.code}</code></td>
                        <td>
                            <small>${sectorsText || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª'}</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="editRank('${rank.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRank('${rank.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 17. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±ØªØ¨Ø©
        function resetRankForm() {
            document.getElementById('rank-form').reset();
            document.getElementById('rank-id').value = '';
            document.querySelectorAll('.sector-checkbox').forEach(cb => cb.checked = false);
            updateAssignedSectorsPreview();
        }
        
        // 18. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function resetUserForm() {
            document.getElementById('user-form').reset();
            document.getElementById('user-id').value = '';
            document.getElementById('user-password').value = '';
        }
        
        // 19. Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø·Ø§Ø¹ (Ù…Ø­Ø¯Ø«Ø©)
        function saveSector(event) {
            event.preventDefault();
            
            if (!currentUser) {
                showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            
            const sectorId = document.getElementById('sector-id').value;
            const name = document.getElementById('sector-name').value;
            const code = document.getElementById('sector-code').value;
            const description = document.getElementById('sector-description').value;
            
            if (!name || !code) {
                showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
                return;
            }
            
            // Ø¬Ù…Ø¹ Ø§Ù„Ø±ØªØ¨ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            const selectedRanks = [];
            document.querySelectorAll('.rank-checkbox:checked').forEach(cb => {
                selectedRanks.push(cb.value);
            });
            
            const sectorData = {
                name,
                code,
                description: description || '',
                ranks: selectedRanks,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.uid
            };
            
            showLoading('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù‚Ø·Ø§Ø¹ ÙÙŠ Firebase...');
            
            if (sectorId) {
                database.ref('sectors/' + sectorId).update(sectorData)
                    .then(() => {
                        hideLoading();
                        showToast('âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Firebase', 'success');
                        resetSectorForm();
                        updateLastUpdateTime();
                    })
                    .catch((error) => {
                        hideLoading();
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø·Ø§Ø¹:', error);
                        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    });
            } else {
                sectorData.createdAt = new Date().toISOString();
                sectorData.createdBy = currentUser.uid;
                
                database.ref('sectors').push(sectorData)
                    .then(() => {
                        hideLoading();
                        showToast('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Firebase', 'success');
                        resetSectorForm();
                        updateLastUpdateTime();
                    })
                    .catch((error) => {
                        hideLoading();
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø·Ø§Ø¹:', error);
                        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    });
            }
        }
        
        // 20. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù‚Ø·Ø§Ø¹
        function resetSectorForm() {
            document.getElementById('sector-form').reset();
            document.getElementById('sector-id').value = '';
            document.querySelectorAll('.rank-checkbox').forEach(cb => cb.checked = false);
            updateAssignedRanksPreview();
        }
        
        // ========== Ø¯ÙˆØ§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ù„ÙˆØ§Ù† ==========
        function setupColorPicker() {
            const colors = [
                '4c4c4c', 'FFFFFF', '000000', 'FF0000', '00FF00', '0000FF',
                'FFFF00', 'FF00FF', '00FFFF', '880000', '008800', '000088',
                '888800', '880088', '008888', 'CCCCCC', '888888', '99d24f'
            ];
            
            const colorGrid = document.getElementById('color-grid');
            if (!colorGrid) return;
            
            let html = '<div class="row">';
            colors.forEach(color => {
                html += `
                    <div class="col-2 mb-2">
                        <div class="color-preview" style="background-color: #${color}; width: 30px; height: 30px; margin: 0 auto; cursor: pointer;"
                             onclick="selectColor('${color}')"></div>
                    </div>
                `;
            });
            html += '</div>';
            colorGrid.innerHTML = html;
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø®ØµØµ
            document.getElementById('custom-color-picker').addEventListener('input', function(e) {
                selectedColor = e.target.value.replace('#', '');
            });
        }
        
        function openColorPicker(fieldId) {
            currentColorField = fieldId;
            document.getElementById('color-picker-overlay').classList.add('active');
            document.getElementById('color-picker-popup').classList.add('active');
        }
        
        function closeColorPicker() {
            document.getElementById('color-picker-overlay').classList.remove('active');
            document.getElementById('color-picker-popup').classList.remove('active');
            currentColorField = '';
            selectedColor = '';
        }
        
        function selectColor(color) {
            selectedColor = color;
            document.getElementById('custom-color-picker').value = '#' + color;
        }
        
        function applySelectedColor() {
            if (currentColorField && selectedColor) {
                const input = document.getElementById(currentColorField);
                const preview = document.getElementById(currentColorField.replace('vehicle-', '') + '-preview');
                
                if (input) {
                    input.value = selectedColor;
                }
                
                if (preview) {
                    preview.style.backgroundColor = '#' + selectedColor;
                }
            }
            closeColorPicker();
        }
        
        // ========== Ø¯ÙˆØ§Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†Ø© ==========
        function setupRanksListener() {
            return new Promise((resolve) => {
                const ranksRef = database.ref('ranks');
                
                const listener = ranksRef.on('value', (snapshot) => {
                    ranks = [];
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            ranks.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                    }
                    
                    console.log(`ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ ${ranks.length} Ø±ØªØ¨Ø© Ù…Ù† Firebase`);
                    document.getElementById('fb-ranks-count').textContent = ranks.length;
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ØªØ¨
                    loadRanksForSectorManagement();
                    loadSectorsForRankManagement();
                    loadSectorsForUserManagement();
                    updateRanksList();
                    
                    resolve();
                });
                
                dataListeners.push(() => ranksRef.off('value', listener));
            });
        }
        
        function setupUsersListener() {
            return new Promise((resolve) => {
                const usersRef = database.ref('users');
                
                const listener = usersRef.on('value', (snapshot) => {
                    users = [];
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            users.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                    }
                    
                    console.log(`ğŸ“Š ØªÙ… ØªØ­Ù…ÙŠÙ„ ${users.length} Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firebase`);
                    document.getElementById('fb-users-count').textContent = users.length;
                    document.getElementById('db-users-status').textContent = `${users.length} Ù…Ø³ØªØ®Ø¯Ù…`;
                    
                    updateDashboardStats();
                    updateUsersList();
                    
                    resolve();
                });
                
                dataListeners.push(() => usersRef.off('value', listener));
            });
        }
        
        // ========== Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø³Ù† ==========
        function searchVehicles() {
            const sectorId = document.getElementById('search-sector').value;
            const rankId = document.getElementById('search-rank').value;
            const type = document.getElementById('search-type').value;
            
            if (!sectorId) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            
            if (!rankId) {
                showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±ØªØ¨Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø·Ø§Ø¹ ÙˆØ§Ù„Ø±ØªØ¨Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            const sector = sectors.find(s => s.id === sectorId);
            const rank = ranks.find(r => r.id === rankId);
            
            if (!sector || !rank) {
                showToast('Ø§Ù„Ù‚Ø·Ø§Ø¹ Ø£Ùˆ Ø§Ù„Ø±ØªØ¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±ØªØ¨Ø© ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ù‚Ø·Ø§Ø¹
            if (sector.ranks && !sector.ranks.includes(rankId)) {
                showToast('Ù‡Ø°Ù‡ Ø§Ù„Ø±ØªØ¨Ø© ØºÙŠØ± ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯', 'error');
                return;
            }
            
            // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª
            let filteredVehicles = vehicles.filter(v => {
                const matchesSector = v.sector === sectorId || v.sectorId === sectorId;
                const matchesRank = v.rank === rankId || v.rankId === rankId;
                return matchesSector && matchesRank;
            });
            
            if (type) {
                filteredVehicles = filteredVehicles.filter(v => v.type === type);
            }
            
            displaySearchResults(filteredVehicles);
        }
        
        // ========== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ø¶Ø§ÙÙŠØ© ==========
        function updateSectorsList() {
            const container = document.getElementById('sectors-list');
            if (!container) return;
            
            let html = '';
            
            sectors.forEach(sector => {
                let ranksText = '';
                if (sector.ranks && sector.ranks.length > 0) {
                    ranksText = sector.ranks.map(rankId => {
                        const rank = ranks.find(r => r.id === rankId);
                        return rank ? rank.name : rankId;
                    }).join(', ');
                }
                
                html += `
                    <tr>
                        <td>${sector.name}</td>
                        <td><code>${sector.code}</code></td>
                        <td>
                            <small>${ranksText || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ØªØ¨'}</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="editSector('${sector.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSector('${sector.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }

        // Ø¨Ø¯Ø§ÙŠØ© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
        console.log('ğŸš€ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ø´Ø±Ø·ÙŠØ© - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©');
        console.log('ğŸ“‹ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:');
        console.log('1. Ø±Ø¨Ø· Ø§Ù„Ø±ØªØ¨ Ù…Ø¹ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª');
        console.log('2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ÙƒØ§Ù…Ù„Ø©');
        console.log('3. ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ');
        console.log('4. Ù…Ø­Ø¯Ø¯ Ø£Ù„ÙˆØ§Ù† Ù…ØªØ·ÙˆØ±');
    </script>
</body>
</html>

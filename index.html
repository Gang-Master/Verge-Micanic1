// أضف هذا الكود بعد تهيئة Firebase مباشرة

// تهيئة التطبيق عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // التحقق من حالة تسجيل الدخول
    auth.onAuthStateChanged(function(user) {
        if (user) {
            currentUser = user;
            loadUserData();
        } else {
            showLogin();
        }
    });
    
    // استعداد النماذج
    setupForms();
    
    // تحميل البيانات الأولية
    loadInitialData();
    
    // إضافة مستخدم افتراضي إذا لم يكن هناك مستخدمين
    createDefaultAdmin();
});

// دالة إعداد النماذج
function setupForms() {
    // نموذج إضافة المركبة
    document.getElementById('add-vehicle-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        addVehicle();
    });
    
    // نموذج إضافة القطاع
    document.getElementById('sector-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveSector();
    });
    
    // نموذج إضافة الرتبة
    document.getElementById('rank-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveRank();
    });
    
    // نموذج إضافة اللون
    document.getElementById('color-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        saveColor();
    });
    
    // نموذج إضافة المستخدم
    document.getElementById('add-user-form')?.addEventListener('submit', function(e) {
        e.preventDefault();
        addNewUser();
    });
    
    // تحديث معاينة الألوان
    document.getElementById('primary-color')?.addEventListener('input', function() {
        updateColorPreview('primary-color-preview', this.value);
    });
    
    document.getElementById('secondary-color')?.addEventListener('input', function() {
        updateColorPreview('secondary-color-preview', this.value);
    });
    
    document.getElementById('color-code')?.addEventListener('input', function() {
        updateColorPreview('color-code-preview', this.value);
    });
    
    // تحديث الفلاتر المتتالية
    document.getElementById('search-sector')?.addEventListener('change', updateFilterDependencies);
    document.getElementById('search-rank')?.addEventListener('change', updateFilterDependencies);
}

// دالة تحميل البيانات الأولية
function loadInitialData() {
    // هذه بيانات افتراضية للقطاعات (يمكن إضافتها يدوياً)
    const initialSectors = [
        { name: "إدارة الشرطة", code: "police" },
        { name: "أمن الموانئ", code: "ports" },
        { name: "وزارة الصحة", code: "health" }
    ];
    
    // هذه بيانات افتراضية للرتب
    const initialRanks = [
        { name: "ملازم", code: "lieutenant" },
        { name: "نقيب", code: "captain" },
        { name: "رائد", code: "major" },
        { name: "مقدم", code: "lieutenant_colonel" },
        { name: "عقيد", code: "colonel" }
    ];
    
    // التحقق مما إذا كانت القطاعات موجودة بالفعل
    database.ref('sectors').once('value').then((snapshot) => {
        if (!snapshot.exists()) {
            // إضافة القطاعات الافتراضية
            initialSectors.forEach((sector, index) => {
                database.ref('sectors/initial-' + sector.code).set({
                    name: sector.name,
                    code: sector.code,
                    createdAt: new Date().toISOString(),
                    createdBy: 'system'
                });
            });
        }
    });
    
    // التحقق مما إذا كانت الرتب موجودة بالفعل
    database.ref('ranks').once('value').then((snapshot) => {
        if (!snapshot.exists()) {
            // إضافة الرتب الافتراضية
            initialRanks.forEach((rank, index) => {
                database.ref('ranks/initial-' + rank.code).set({
                    name: rank.name,
                    code: rank.code,
                    createdAt: new Date().toISOString(),
                    createdBy: 'system'
                });
            });
        }
    });
}

// دالة الحصول على اسم الدور
function getRoleName(roleCode) {
    const roles = {
        'admin': 'مدير',
        'editor': 'محرر',
        'viewer': 'مشاهد'
    };
    return roles[roleCode] || roleCode;
}

// دالة عرض الخطأ
function showError(element, message) {
    element.textContent = message;
    element.classList.remove('d-none');
}

// دالة إخفاء الخطأ
function hideError(element) {
    element.classList.add('d-none');
}

// دالة تحويل رسالة خطأ Firebase
function getAuthErrorMessage(errorCode) {
    const messages = {
        'auth/invalid-email': 'البريد الإلكتروني غير صالح',
        'auth/user-disabled': 'هذا الحساب معطل',
        'auth/user-not-found': 'لا يوجد حساب بهذا البريد الإلكتروني',
        'auth/wrong-password': 'كلمة المرور غير صحيحة',
        'auth/email-already-in-use': 'البريد الإلكتروني مستخدم بالفعل',
        'auth/weak-password': 'كلمة المرور ضعيفة، يجب أن تتكون من 6 أحرف على الأقل',
        'auth/operation-not-allowed': 'عملية التسجيل غير مسموحة حالياً',
        'auth/too-many-requests': 'تم رفض الوصول بسبب محاولات متكررة، يرجى المحاولة لاحقاً'
    };
    
    return messages[errorCode] || 'حدث خطأ غير معروف، يرجى المحاولة مرة أخرى';
}

// دالة تحديث الصلاحيات بناءً على دور المستخدم
function updatePermissions(role) {
    // إخفاء/إظهار العناصر بناءً على الدور
    const adminOnly = [
        'manage-users-link', 
        'manage-sectors-link', 
        'manage-ranks-link', 
        'manage-colors-link', 
        'add-vehicle-link',
        'add-user-link',
        'system-tools-link'
    ];
    const editorOnly = ['add-vehicle-link'];
    
    // إخفاء جميع العناصر أولاً
    adminOnly.concat(editorOnly).forEach(id => {
        const element = document.getElementById(id);
        if (element) element.style.display = 'none';
    });
    
    // إظهار العناصر بناءً على الدور
    if (role === 'admin') {
        adminOnly.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.style.display = 'block';
        });
    } else if (role === 'editor') {
        editorOnly.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.style.display = 'block';
        });
    }
}

// دالة إعادة تعيين نموذج المركبة
function resetVehicleForm() {
    document.getElementById('add-vehicle-form').reset();
    document.getElementById('edit-vehicle-id').value = '';
    document.getElementById('vehicle-form-title').textContent = 'إضافة مركبة جديدة';
    document.getElementById('save-vehicle-btn').innerHTML = '<i class="fas fa-save me-2"></i>حفظ المركبة';
    updateColorPreview('primary-color-preview', '');
    updateColorPreview('secondary-color-preview', '');
}

// دالة إعادة تعيين نموذج القطاع
function resetSectorForm() {
    document.getElementById('sector-form').reset();
    document.getElementById('edit-sector-id').value = '';
    document.getElementById('save-sector-btn').innerHTML = '<i class="fas fa-save me-2"></i>حفظ القطاع';
}

// دالة إعادة تعيين نموذج الرتبة
function resetRankForm() {
    document.getElementById('rank-form').reset();
    document.getElementById('edit-rank-id').value = '';
    document.getElementById('save-rank-btn').innerHTML = '<i class="fas fa-save me-2"></i>حفظ الرتبة';
}

// دالة إعادة تعيين نموذج اللون
function resetColorForm() {
    document.getElementById('color-form').reset();
    document.getElementById('edit-color-id').value = '';
    document.getElementById('save-color-btn').innerHTML = '<i class="fas fa-save me-2"></i>حفظ اللون';
    updateColorPreview('color-code-preview', '');
}

// دالة تحديث معاينة اللون
function updateColorPreview(elementId, colorValue) {
    const element = document.getElementById(elementId);
    if (element && colorValue) {
        element.style.backgroundColor = '#' + colorValue;
    } else if (element) {
        element.style.backgroundColor = '';
    }
}

// دالة تحديث القوائم المنسدلة للقطاعات
function updateSectorDropdowns() {
    const searchSector = document.getElementById('search-sector');
    const vehicleSector = document.getElementById('vehicle-sector');
    
    let searchOptions = '<option value="">اختر القطاع</option>';
    let vehicleOptions = '<option value="">اختر القطاع</option>';
    
    sectors.forEach(sector => {
        searchOptions += `<option value="${sector.id}">${sector.name}</option>`;
        vehicleOptions += `<option value="${sector.id}">${sector.name}</option>`;
    });
    
    if (searchSector) searchSector.innerHTML = searchOptions;
    if (vehicleSector) vehicleSector.innerHTML = vehicleOptions;
}

// دالة تحديث القوائم المنسدلة للرتب
function updateRankDropdowns() {
    const searchRank = document.getElementById('search-rank');
    const vehicleRank = document.getElementById('vehicle-rank');
    
    let searchOptions = '<option value="">اختر الرتبة</option>';
    let vehicleOptions = '<option value="">اختر الرتبة</option>';
    
    ranks.forEach(rank => {
        searchOptions += `<option value="${rank.id}">${rank.name}</option>`;
        vehicleOptions += `<option value="${rank.id}">${rank.name}</option>`;
    });
    
    if (searchRank) searchRank.innerHTML = searchOptions;
    if (vehicleRank) vehicleRank.innerHTML = vehicleOptions;
}

// دالة تحديث جدول القطاعات
function updateSectorsTable() {
    const tbody = document.querySelector('#sectors-table tbody');
    if (!tbody) return;
    
    if (sectors.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center">لا توجد قطاعات مضافة بعد</td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    
    sectors.forEach(sector => {
        const vehicleCount = vehicles.filter(v => v.sector === sector.id).length;
        
        html += `
            <tr>
                <td>${sector.name}</td>
                <td><code>${sector.code}</code></td>
                <td>${vehicleCount}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="editSector('${sector.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSector('${sector.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// دالة تعديل قطاع
function editSector(sectorId) {
    const sector = sectors.find(s => s.id === sectorId);
    if (!sector) return;
    
    document.getElementById('edit-sector-id').value = sectorId;
    document.getElementById('sector-name').value = sector.name;
    document.getElementById('sector-code').value = sector.code;
    document.getElementById('sector-description').value = sector.description || '';
    
    document.getElementById('save-sector-btn').innerHTML = '<i class="fas fa-save me-2"></i>تحديث القطاع';
    
    showSection('manage-sectors');
}

// دالة حذف قطاع
function deleteSector(sectorId) {
    if (confirm('هل أنت متأكد من حذف هذا القطاع؟')) {
        database.ref('sectors/' + sectorId).remove()
            .then(() => {
                showToast('تم حذف القطاع بنجاح', 'success');
                loadSectors();
            })
            .catch((error) => {
                showToast('حدث خطأ أثناء الحذف: ' + error.message, 'error');
            });
    }
}

// دالة تحديث جدول الرتب
function updateRanksTable() {
    const tbody = document.querySelector('#ranks-table tbody');
    if (!tbody) return;
    
    if (ranks.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center">لا توجد رتب مضافة بعد</td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    
    ranks.forEach(rank => {
        const vehicleCount = vehicles.filter(v => v.rank === rank.id).length;
        
        html += `
            <tr>
                <td>${rank.name}</td>
                <td><code>${rank.code}</code></td>
                <td>${vehicleCount}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="editRank('${rank.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteRank('${rank.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// دالة تعديل رتبة
function editRank(rankId) {
    const rank = ranks.find(r => r.id === rankId);
    if (!rank) return;
    
    document.getElementById('edit-rank-id').value = rankId;
    document.getElementById('rank-name').value = rank.name;
    document.getElementById('rank-code').value = rank.code;
    document.getElementById('rank-description').value = rank.description || '';
    
    document.getElementById('save-rank-btn').innerHTML = '<i class="fas fa-save me-2"></i>تحديث الرتبة';
    
    showSection('manage-ranks');
}

// دالة حذف رتبة
function deleteRank(rankId) {
    if (confirm('هل أنت متأكد من حذف هذه الرتبة؟')) {
        database.ref('ranks/' + rankId).remove()
            .then(() => {
                showToast('تم حذف الرتبة بنجاح', 'success');
                loadRanks();
            })
            .catch((error) => {
                showToast('حدث خطأ أثناء الحذف: ' + error.message, 'error');
            });
    }
}

// دالة تحديث قائمة الألوان
function updateColorsList() {
    const container = document.getElementById('colors-list');
    if (!container) return;
    
    if (colors.length === 0) {
        container.innerHTML = '<p class="text-muted">لا توجد ألوان مسجلة بعد</p>';
        return;
    }
    
    let html = '';
    
    colors.forEach(color => {
        html += `
            <div class="col-md-3 col-sm-4 col-6 mb-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="color-preview mx-auto mb-2" style="background-color: #${color.code}; width: 50px; height: 50px;"></div>
                        <h6>${color.name}</h6>
                        <small>#${color.code}</small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editColor('${color.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteColor('${color.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// دالة تعديل لون
function editColor(colorId) {
    const color = colors.find(c => c.id === colorId);
    if (!color) return;
    
    document.getElementById('edit-color-id').value = colorId;
    document.getElementById('color-code').value = color.code;
    document.getElementById('color-name').value = color.name;
    
    updateColorPreview('color-code-preview', color.code);
    
    document.getElementById('save-color-btn').innerHTML = '<i class="fas fa-save me-2"></i>تحديث اللون';
    
    showSection('manage-colors');
}

// دالة حذف لون
function deleteColor(colorId) {
    if (confirm('هل أنت متأكد من حذف هذا اللون؟')) {
        database.ref('colors/' + colorId).remove()
            .then(() => {
                showToast('تم حذف اللون بنجاح', 'success');
                loadColors();
            })
            .catch((error) => {
                showToast('حدث خطأ أثناء الحذف: ' + error.message, 'error');
            });
    }
}

// دالة تحديث الألوان الشائعة
function updateCommonColors() {
    const container = document.getElementById('common-colors');
    if (!container) return;
    
    const commonColors = [
        { code: '4c4c4c', name: 'رمادي' },
        { code: 'FFFFFF', name: 'أبيض' },
        { code: '000000', name: 'أسود' },
        { code: 'FF0000', name: 'أحمر' },
        { code: '0000FF', name: 'أزرق' },
        { code: '008000', name: 'أخضر' },
        { code: '880000', name: 'أحمر غامق' },
        { code: '99d24f', name: 'أخضر فاتح' }
    ];
    
    let html = '';
    
    commonColors.forEach(color => {
        html += `
            <div class="color-option" style="cursor: pointer;" onclick="selectCommonColor('${color.code}')">
                <div class="color-preview" style="background-color: #${color.code}; width: 30px; height: 30px;" title="${color.name}"></div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// دالة اختيار لون شائع
function selectCommonColor(colorCode) {
    document.getElementById('color-hex').value = colorCode;
    document.getElementById('color-picker').value = '#' + colorCode;
}

// دالة تحديث جدول المستخدمين
function updateUsersTable() {
    const tbody = document.querySelector('#users-table tbody');
    if (!tbody) return;
    
    if (users.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center">لا توجد مستخدمين مسجلين</td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    
    users.forEach(user => {
        // تجنب عرض المستخدم الحالي في قائمة الحذف
        const isCurrentUser = user.id === currentUser.uid;
        
        html += `
            <tr>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td><span class="user-badge badge-${user.role}">${getRoleName(user.role)}</span></td>
                <td>${formatDate(user.createdAt)}</td>
                <td>
                    ${!isCurrentUser ? `
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editUser('${user.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : '<span class="text-muted">المستخدم الحالي</span>'}
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// دالة تنسيق التاريخ
function formatDate(dateString) {
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('ar-EG');
    } catch (e) {
        return 'غير معروف';
    }
}

// دالة تحديث الإحصائيات
function updateDashboardStats() {
    // تعداد المستخدمين حسب الدور
    const adminCount = users.filter(u => u.role === 'admin').length;
    const editorCount = users.filter(u => u.role === 'editor').length;
    const viewerCount = users.filter(u => u.role === 'viewer').length;
    
    const adminCountElement = document.getElementById('admin-count');
    const editorCountElement = document.getElementById('editor-count');
    const viewerCountElement = document.getElementById('viewer-count');
    const vehicleCountElement = document.getElementById('vehicle-count');
    
    if (adminCountElement) adminCountElement.textContent = adminCount;
    if (editorCountElement) editorCountElement.textContent = editorCount;
    if (viewerCountElement) viewerCountElement.textContent = viewerCount;
    if (vehicleCountElement) vehicleCountElement.textContent = vehicles.length;
    
    // تحديث الرسم البياني
    updateChart();
}

// دالة تحديث المركبات الأخيرة
function updateRecentVehicles() {
    const container = document.getElementById('recent-vehicles');
    if (!container) return;
    
    const recentVehicles = vehicles.slice(-5).reverse();
    
    if (recentVehicles.length === 0) {
        container.innerHTML = '<p class="text-muted">لا توجد مركبات مضافة بعد</p>';
        return;
    }
    
    let html = '<div class="list-group">';
    
    recentVehicles.forEach(vehicle => {
        const sectorName = getSectorName(vehicle.sector);
        html += `
            <a href="#" class="list-group-item list-group-item-action" onclick="editVehicle('${vehicle.id}')">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${vehicle.type}</h6>
                    <small>${formatDate(vehicle.createdAt)}</small>
                </div>
                <p class="mb-1">${sectorName} - ${vehicle.code}</p>
            </a>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// دالة عرض صفحة تسجيل الدخول
function showLogin() {
    document.getElementById('login-page')?.classList.remove('d-none');
    document.getElementById('register-page')?.classList.add('d-none');
    document.getElementById('dashboard')?.classList.add('d-none');
}

// دالة عرض لوحة التحكم
function showDashboard() {
    document.getElementById('login-page')?.classList.add('d-none');
    document.getElementById('register-page')?.classList.add('d-none');
    document.getElementById('dashboard')?.classList.remove('d-none');
    showSection('dashboard-home');
}

// دالة تبديل الشريط الجانبي
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar?.classList.toggle('active');
}

// دالة تغيير القسم
function showSection(sectionId) {
    // إخفاء جميع الأقسام
    document.querySelectorAll('.dashboard-section').forEach(section => {
        section.classList.add('d-none');
    });
    
    // إزالة النشط من جميع عناصر القائمة
    document.querySelectorAll('.sidebar a').forEach(link => {
        link.classList.remove('active');
    });
    
    // إظهار القسم المطلوب
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.remove('d-none');
    }
    
    // إضافة النشط إلى العنصر المناسب في القائمة الجانبية
    const sectionNames = {
        'dashboard-home': 'لوحة التحكم',
        'search-vehicles': 'بحث المركبات',
        'add-vehicle': 'إضافة مركبة',
        'manage-sectors': 'إدارة القطاعات',
        'manage-ranks': 'إدارة الرتب',
        'manage-colors': 'إدارة الألوان',
        'manage-users': 'إدارة المستخدمين',
        'add-user': 'إضافة مستخدم',
        'system-tools': 'أدوات النظام'
    };
    
    const sectionName = sectionNames[sectionId];
    if (sectionName) {
        const activeLink = Array.from(document.querySelectorAll('.sidebar a')).find(link => 
            link.textContent.includes(sectionName)
        );
        
        if (activeLink) {
            activeLink.classList.add('active');
        }
    }
}

// دالة إعادة تعيين البحث
function resetSearch() {
    document.getElementById('search-sector').value = '';
    document.getElementById('search-rank').value = '';
    document.getElementById('search-type').value = '';
    
    // تحديث حالة الفلاتر
    updateFilterDependencies();
    
    // عرض جميع المركبات
    displayVehicles(vehicles);
}

// دالة تسجيل الخروج
function logout() {
    auth.signOut().then(() => {
        currentUser = null;
        userRole = null;
        showLogin();
    }).catch((error) => {
        console.error('خطأ في تسجيل الخروج:', error);
    });
}
